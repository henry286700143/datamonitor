<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.viewstar.jsdatamonitor.persistence.UserStateMapper">
<select id="getUserState" parameterType="java.util.Hashtable" resultType="java.util.HashMap">
	SELECT t1.USERID as USERID,
       NVL2(t2.USERID, '4', '1') as STATE,
       NVL(T3.branchname, 'NULL') as branchname,
       NVL(T3.TEL, 'NULL') as TEL,
       NVL(T3.ADDR, 'NULL') as ADDR,
       NVL(TO_CHAR(T4.LOGINTIME, 'YYYY-MM-DD HH24:MI:SS'),'1970-01-01 00:00:00') AS LASTLOGINTIME,
       NVL(T4.TYPE,-1) AS LASTTYPE,
       NVL(T4.STBMODEL, 'NULL') as LASTSTBMODEL,
       NVL(TO_CHAR(T5.LOGINTIME, 'YYYY-MM-DD HH24:MI:SS'),'1970-01-01 00:00:00') AS ALASTLOGINTIME,
       NVL(T5.TYPE,-1) AS ALASTTYPE,
       NVL(TO_CHAR(T6.LOGINTIME, 'YYYY-MM-DD HH24:MI:SS'),'1970-01-01 00:00:00') AS FIRSTLOGINTIME,
       NVL(T6.TYPE,-1) AS FIRSTTYPE,
       NVL(T6.STBMODEL, 'NULL') as FIRSTSTBMODEL
  FROM ((SELECT '${userid}' AS USERID FROM DUAL) T1 left join
        (SELECT distinct USERID
           from (SELECT USERID,
                        TIME,
                        STATE,
                        ROW_NUMBER() OVER(PARTITION BY USERID ORDER BY time DESC) as rnum
                   from (SELECT USERID, TIME, STATE
                           from (
                                --中兴拆机
                                 (select userid,
                                         status      as STATE,
                                         datecreated as time
                                    from DAMS.USERINFO_C3 t
                                   where (service = 1 or service = 3)
                                     and status = 4) union
                                --华为注销和拆机
                                 (select userid, 4 as STATE, time
                                    from DAMS.USERINFO_C3_HW_CHAIJI t
                                   where t.status is null)
                                
                                 union (select userid, status as STATE, time
                                          from DAMS.USERINFO_C3_HW_CHAIJI t
                                         where status = 4))))
          where STATE = 4
            and rnum = 1) T2 ON T1.USERID = T2.USERID)
  LEFT JOIN (SELECT userid, branchname, TEL, ADDR, num
               from (SELECT userid,
                            branchname,
                            TEL,
                            ADDR,
                            ROW_NUMBER() OVER(PARTITION BY USERID ORDER BY updatetime, time DESC) as num
                       from USERINFO_WORK_FINISH)
              where num = 1) T3
    ON T1.USERID = T3.USERID
    --最近一次开机
  LEFT JOIN (SELECT USERID, LOGINTIME, TYPE, STBMODEL from USERINFO_EPG_LAST) T4
    ON T1.USERID = T4.USERID
    --最近一次活跃
  LEFT JOIN (SELECT USERID, LOGINTIME, TYPE from USERINFO_ACTIVE_LAST) T5
    ON T1.USERID = T5.USERID
    --最早一次开机
  LEFT JOIN (SELECT USERID, LOGINTIME, TYPE, STBMODEL
               FROM USERINFO_EPG_FIRST) T6
    ON T1.USERID = T6.USERID
</select>

<select id="getUserOrderState" parameterType="java.util.Hashtable" resultType="java.util.HashMap">
	select t111.PRODUCTID as PRODUCTID,
       NVL2(t222.STATE,t222.STATE,'-1') as STATE,
       t111.name as  name,
       t222.USERID as USERID,t222.TIME as TIME from 
	(SELECT NAME,productid FROM 
	 (SELECT '彩虹live' AS name,'gdprdt084' AS productid,'31' AS state FROM DUAL
	UNION ALL
	SELECT '5.1尊享包' AS name,  'gdprdt399'  AS productid,'31' AS state FROM DUAL
	UNION ALL
	SELECT 'CCTV尊享频道包' AS name,  'gdprdt143'  AS productid,'31' AS state FROM DUAL
	UNION ALL
	SELECT '彩虹音乐' AS name, 'gdprdt054' AS productid,'31' AS state FROM DUAL
	UNION ALL
	SELECT '畅享私家频道包' AS name, 'gdprdt060' AS productid,'31' AS state  FROM DUAL
	UNION ALL
	SELECT '津彩影院' AS name, 'gdprdt018' AS productid,'31' AS state    FROM DUAL
	UNION ALL
	SELECT '津彩剧场' AS name,  'gdprdt027' AS productid,'31' AS state   FROM DUAL
	UNION ALL
	SELECT '好莱坞片场' AS name,  'gdprdt045' AS productid,'31' AS state    FROM DUAL
	UNION ALL
	SELECT '聚好看' AS name, 'gdprdt039' AS productid,'31' AS state  FROM DUAL
	UNION ALL
	SELECT '津彩动漫' AS name, 'gdprdt075' AS productid,'31' AS state   FROM DUAL
	UNION ALL
	SELECT '环球影视' AS name, 'gdprdt093' AS productid,'31' AS state   FROM DUAL           
	))t111 left join
	(select USERID,TIME,PRODUCTID,STATE,num from
	(select USERID,TIME,PRODUCTID,STATE,ROW_NUMBER() OVER(PARTITION BY USERID, productid ORDER BY time DESC) as num
	from (select userid, time, productid, state
	  from (select t1.userid    as userid,
	               t1.time      as time,
	               t1.productid as productid,
	               t1.state     as state
	          from CHARGES_DATA t1 
	          where t1.userid = '${userid}')
	        union 
	        (select t1.userid    as userid,
	              t1.time      as time,
	              t1.productid as productid,
	              t1.state     as state
	         from CHARGES_DATA_RT@Dataaly t1
	         where t1.userid =  '${userid}')
	))where num=1)t222 
	 on t111.PRODUCTID = t222.PRODUCTID
</select>

<select id="getConvertType" parameterType="java.util.Hashtable" resultType="java.lang.String">
	select note from USERGROUP t where t.type = '${type}'
</select>
</mapper>